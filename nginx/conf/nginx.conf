# 基础工作进程配置
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # 基本 MIME 与传输设置
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout  65;

    # 开启 Gzip 并支持直接发送打包生成的 .gz 资源
    # 参考 vue.config.js 配置的 CompressionPlugin（e:/code/.../vue.config.js:84–90）
    gzip on;
    gzip_static on;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/javascript application/json application/xml image/svg+xml;

    # WebSocket 连接升级辅助（供部分复杂场景使用）
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # 接口后端上游（Vue devServer 代理到 192.168.1.80:8080，vue.config.js:41）
    upstream backend_api {
        server 192.168.1.169:8080;
    }

    # 流媒体/推流 WebSocket 上游（vue.config.js 中 /stream-ws → 192.168.1.80:9999，行48–55）
    upstream stream_ws {
        server 192.168.1.169:9999;
        # 如果你需要使用公网地址（例如你现有文件中的 125.223.225.157:9999），把上面 IP 改为该地址
        # server 125.223.225.157:9999;
    }

    # 全局 WebSocket 上游（vue.config.js 中 /global-ws → 192.168.1.80:8080，行56–63）
    upstream global_ws {
        server 192.168.1.169:8080;
        # 如需公网地址替换为你的实际服务 IP:PORT
        # server 125.223.225.157:8080;
    }

    # 站点服务（HTTP 80）
    server {
        listen       80;
        server_name  _;

        # 静态资源根目录：将前端打包后的 dist 内容放到此目录
        # outputDir: "dist", assetsDir: "static"（e:/code/.../vue.config.js:24–26）
        root  /usr/share/nginx/html;
        index index.html;

        # 上传/响应体大小限制（按需调整）
        client_max_body_size 50m;

        # 前端路由（SPA）回退：保证前端路由在刷新时可用
        location / {
            try_files $uri $uri/ /index.html;
        }

        # 接口代理：以 VUE_APP_BASE_API 为前缀进行转发，并移除前缀（与 devServer 的 pathRewrite 一致，vue.config.js:44–46）
        # 若你的实际前缀不是 /prod-api，请替换为真正的值
        location ^~ /prod-api/ {
            proxy_pass         http://backend_api/;   # 末尾 / 能正确去除前缀
            proxy_http_version 1.1;
            proxy_set_header   Host $host;
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
        }

        # WebSocket：/stream-ws → 192.168.1.80:9999（vue.config.js:48–55）
        location /stream-ws/ {
            proxy_pass         http://stream_ws/;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection $connection_upgrade;
            proxy_set_header   Host $host;
            proxy_read_timeout 600s;
        }

        # WebSocket：/global-ws → 192.168.1.80:8080（vue.config.js:56–63）
        location /global-ws/ {
            proxy_pass         http://global_ws/;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection $connection_upgrade;
            proxy_set_header   Host $host;
            proxy_read_timeout 600s;
        }

        # 静态资源缓存策略（按需调整）
        location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico)$ {
            expires 30d;
            access_log off;
        }
    }
}
